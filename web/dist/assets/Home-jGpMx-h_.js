import{o as Q,a as X,b as u,c as v,d as t,e as M,w as R,n as f,t as r,f as m,g,h as w,v as C,r as n,i as Y,j as h}from"./index-DZPuk-FT.js";import{a as V}from"./index-Dnk_-Q5K.js";const ee={class:"container"},te={class:"header"},le={style:{display:"flex",gap:"12px","justify-content":"center","margin-top":"16px"}},oe={class:"step-indicator"},se={class:"step-number"},ae={class:"step-number"},ne={class:"step-number"},re={key:0},ie={class:"price-cards"},de={class:"price"},ue={class:"price"},ve=["disabled"],pe={key:1,class:"card"},ce={class:"form-group"},me={key:0},be={class:"form-group"},ye={class:"form-group"},fe={class:"form-group"},ge={class:"form-group"},xe={key:1},ke={style:{display:"flex",gap:"12px","margin-top":"20px"}},we=["disabled"],Ce={key:2,class:"card"},Ie={class:"order-info"},Se={class:"order-info-row"},Oe={class:"order-info-row"},Ue={style:{color:"var(--primary)","font-weight":"600"}},Ae={class:"order-info-row"},Pe={style:{color:"var(--danger)","font-weight":"600"}},Te={key:0,class:"alert alert-danger",style:{"margin-bottom":"16px"}},$e={class:"qrcode-container"},ze=["src"],Ve={key:1,style:{padding:"40px",background:"var(--bg-input)","border-radius":"8px"}},qe={style:{color:"var(--warning)","font-size":"0.9rem","margin-top":"8px"}},De=["disabled"],Ee=["disabled"],Ne={style:{"text-align":"center",color:"var(--text-muted)","margin-top":"12px","font-size":"0.9rem"}},_e={key:3,class:"card"},Fe={class:"key-display"},Re={__name:"Home",setup(Be){const s=n(1),p=n(null),x=n({builtin:60,custom:50,builtinStock:0}),I=n(""),S=n(""),O=n(""),q=n(""),D=n(""),U=n(!1),i=n(600);let d=null;const b=n(""),A=n(0),k=n(""),E=n(0),P=n(!1),T=n(!1),$=n(""),j=h(()=>{const l=Math.floor(i.value/60),e=i.value%60;return`${l.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`});function _(l=null){if(d&&clearInterval(d),l){const e=l+6e5,o=Math.floor((e-Date.now())/1e3);i.value=Math.max(0,o)}else i.value=600;i.value>0&&(d=setInterval(()=>{i.value>0?i.value--:(clearInterval(d),d=null)},1e3))}function N(){d&&(clearInterval(d),d=null),b.value="",A.value=0,k.value="",E.value=0,i.value=600,s.value=1,localStorage.removeItem("pendingOrder")}Q(async()=>{try{const{data:e}=await V.get("/api/prices");x.value=e}catch(e){console.error("获取价格失败",e)}const l=localStorage.getItem("pendingOrder");if(l)try{const e=JSON.parse(l),o=e.createdAt+10*60*1e3;Date.now()<o?(b.value=e.orderId,A.value=e.amount,k.value=e.qrcodeUrl,E.value=e.createdAt,p.value=e.plan,s.value=3,_(e.createdAt)):localStorage.removeItem("pendingOrder")}catch(e){console.error("恢复订单失败",e),localStorage.removeItem("pendingOrder")}}),X(()=>{d&&(clearInterval(d),d=null)});function F(l){p.value=l}function J(){p.value,s.value=2}async function G(){var l,e;U.value=!0;try{const o=p.value==="builtin"?"/api/order/builtin":"/api/order/custom",a={contactEmail:I.value},z=p.value==="custom"?{...a,email:S.value,password:O.value,recoveryEmail:q.value,totpSecret:D.value}:a,{data:c}=await V.post(o,z),y=c.createdAt?new Date(c.createdAt+"Z").getTime():Date.now();b.value=c.orderId,A.value=c.amount,k.value=c.qrcodeUrl,E.value=y,s.value=3,localStorage.setItem("pendingOrder",JSON.stringify({orderId:c.orderId,amount:c.amount,qrcodeUrl:c.qrcodeUrl,createdAt:y,plan:p.value})),_(y)}catch(o){alert(((e=(l=o.response)==null?void 0:l.data)==null?void 0:e.error)||"创建订单失败")}finally{U.value=!1}}async function H(){P.value=!0;try{const{data:l}=await V.get(`/api/order/${b.value}`);l.status==="paid"?($.value=l.keyCode,s.value=4,localStorage.removeItem("pendingOrder"),d&&(clearInterval(d),d=null)):alert("订单尚未确认，请稍后再试或联系管理员")}catch{alert("查询失败，请稍后再试")}finally{P.value=!1}}async function K(){var l,e,o,a,z,c;if(confirm("确定要取消订单吗？取消后账号将被释放。")){T.value=!0;try{await V.post(`/api/order/${b.value}/cancel`),N()}catch(y){((l=y.response)==null?void 0:l.status)===404||(a=(o=(e=y.response)==null?void 0:e.data)==null?void 0:o.error)!=null&&a.includes("不存在")?N():alert(((c=(z=y.response)==null?void 0:z.data)==null?void 0:c.error)||"取消订单失败")}finally{T.value=!1}}}function W(){B($.value,"密钥已复制到剪贴板")}function Z(){const o=`powershell -Command "Invoke-WebRequest -Uri '${`${window.location.origin}/api/download/${$.value}`}' -OutFile 'cliproxyapi.zip'; Expand-Archive -Path 'cliproxyapi.zip' -DestinationPath '.' -Force; Remove-Item 'cliproxyapi.zip'; Start-Process cmd -ArgumentList '/k','cd /d cliproxyapi && start.bat'"`;B(o,`部署命令已复制！

请粘贴到 PowerShell 执行`)}function B(l,e){navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(l).then(()=>{alert(e)}).catch(()=>{L(l,e)}):L(l,e)}function L(l,e){const o=document.createElement("textarea");o.value=l,o.style.position="fixed",o.style.left="-9999px",o.style.top="-9999px",document.body.appendChild(o),o.focus(),o.select();try{document.execCommand("copy"),alert(e)}catch{alert("复制失败，请手动复制")}document.body.removeChild(o)}return(l,e)=>{const o=Y("router-link");return u(),v("div",ee,[t("div",te,[e[10]||(e[10]=t("h1",null,"CLIProxyAPI 一键部署",-1)),e[11]||(e[11]=t("p",null,"快速部署您的 AI 代理服务，支持 Claude Code / Gemini CLI / Codex",-1)),t("div",le,[M(o,{to:"/query",class:"admin-link"},{default:R(()=>[...e[8]||(e[8]=[m("密钥查询",-1)])]),_:1}),M(o,{to:"/admin",class:"admin-link"},{default:R(()=>[...e[9]||(e[9]=[m("管理后台",-1)])]),_:1})])]),t("div",oe,[t("div",{class:f(["step",{active:s.value===1,completed:s.value>1}])},[t("div",se,r(s.value>1?"✓":"1"),1),e[12]||(e[12]=t("div",{class:"step-label"},"选择方案",-1))],2),t("div",{class:f(["step",{active:s.value===2,completed:s.value>2}])},[t("div",ae,r(s.value>2?"✓":"2"),1),e[13]||(e[13]=t("div",{class:"step-label"},"填写信息",-1))],2),t("div",{class:f(["step",{active:s.value===3,completed:s.value>3}])},[t("div",ne,r(s.value>3?"✓":"3"),1),e[14]||(e[14]=t("div",{class:"step-label"},"扫码支付",-1))],2),t("div",{class:f(["step",{active:s.value===4}])},[...e[15]||(e[15]=[t("div",{class:"step-number"},"4",-1),t("div",{class:"step-label"},"获取密钥",-1)])],2)]),s.value===1?(u(),v("div",re,[t("div",ie,[t("div",{class:f(["price-card",{selected:p.value==="builtin"}]),onClick:e[0]||(e[0]=a=>F("builtin"))},[e[17]||(e[17]=t("div",{class:"tag"},"推荐",-1)),e[18]||(e[18]=t("h3",null,"内置账号",-1)),t("div",de,[m("¥"+r(x.value.builtin),1),e[16]||(e[16]=t("span",null,"/次",-1))]),e[19]||(e[19]=t("p",{class:"desc"},[m("无需谷歌账号，系统自动分配"),t("br"),m("快速上手，即买即用")],-1)),t("div",{class:f(["stock-info",{"stock-low":x.value.builtinStock<=3,"stock-out":x.value.builtinStock===0}])}," 库存: "+r(x.value.builtinStock)+" 个 ",3)],2),t("div",{class:f(["price-card",{selected:p.value==="custom"}]),onClick:e[1]||(e[1]=a=>F("custom"))},[e[21]||(e[21]=t("h3",null,"自有账号",-1)),t("div",ue,[m("¥"+r(x.value.custom),1),e[20]||(e[20]=t("span",null,"/次",-1))]),e[22]||(e[22]=t("p",{class:"desc"},[m("使用您自己的谷歌账号"),t("br"),m("更灵活，可自行管理")],-1))],2)]),t("button",{class:"btn btn-primary btn-block",onClick:J,disabled:!p.value}," 下一步 ",8,ve)])):g("",!0),s.value===2?(u(),v("div",pe,[e[32]||(e[32]=t("h2",{class:"card-title"},"填写信息",-1)),t("div",ce,[e[23]||(e[23]=t("label",{class:"form-label"},[m("联系邮箱 "),t("span",{style:{color:"var(--danger)"}},"*")],-1)),w(t("input",{type:"email",class:"input","onUpdate:modelValue":e[2]||(e[2]=a=>I.value=a),placeholder:"用于接收订单通知"},null,512),[[C,I.value]]),e[24]||(e[24]=t("p",{style:{color:"var(--text-muted)","font-size":"0.85rem","margin-top":"8px"}}," 订单状态变更时将发送通知到此邮箱 ",-1))]),p.value==="custom"?(u(),v("div",me,[t("div",be,[e[25]||(e[25]=t("label",{class:"form-label"},[m("谷歌账号邮箱 "),t("span",{style:{color:"var(--danger)"}},"*")],-1)),w(t("input",{type:"email",class:"input","onUpdate:modelValue":e[3]||(e[3]=a=>S.value=a),placeholder:"your-email@gmail.com"},null,512),[[C,S.value]])]),t("div",ye,[e[26]||(e[26]=t("label",{class:"form-label"},[m("谷歌密码 "),t("span",{style:{color:"var(--danger)"}},"*")],-1)),w(t("input",{type:"password",class:"input","onUpdate:modelValue":e[4]||(e[4]=a=>O.value=a),placeholder:"请输入谷歌账号密码"},null,512),[[C,O.value]])]),t("div",fe,[e[27]||(e[27]=t("label",{class:"form-label"},"辅助邮箱 (可选)",-1)),w(t("input",{type:"email",class:"input","onUpdate:modelValue":e[5]||(e[5]=a=>q.value=a),placeholder:"recovery@example.com"},null,512),[[C,q.value]]),e[28]||(e[28]=t("p",{style:{color:"var(--text-muted)","font-size":"0.85rem","margin-top":"8px"}}," 用于账号验证时的备用邮箱 ",-1))]),t("div",ge,[e[29]||(e[29]=t("label",{class:"form-label"},"2FA密钥/应用密码 (可选)",-1)),w(t("input",{type:"text",class:"input","onUpdate:modelValue":e[6]||(e[6]=a=>D.value=a),placeholder:"TOTP密钥或应用专用密码"},null,512),[[C,D.value]]),e[30]||(e[30]=t("p",{style:{color:"var(--text-muted)","font-size":"0.85rem","margin-top":"8px"}}," 如有两步验证，请填写TOTP密钥；如未启用2FA可留空，部署时会提示配置 ",-1))])])):(u(),v("div",xe,[...e[31]||(e[31]=[t("div",{class:"alert alert-success"}," 系统将自动为您分配一个可用的谷歌账号 ",-1)])])),t("div",ke,[t("button",{class:"btn",style:{background:"var(--bg-input)"},onClick:e[7]||(e[7]=a=>s.value=1)}," 上一步 "),t("button",{class:"btn btn-primary",style:{flex:"1"},onClick:G,disabled:U.value||!I.value||p.value==="custom"&&(!S.value||!O.value)},r(U.value?"创建中...":"创建订单"),9,we)])])):g("",!0),s.value===3?(u(),v("div",Ce,[e[39]||(e[39]=t("h2",{class:"card-title"},"扫码支付",-1)),t("div",Ie,[t("div",Se,[e[33]||(e[33]=t("span",null,"订单号",-1)),t("span",null,r(b.value),1)]),t("div",Oe,[e[34]||(e[34]=t("span",null,"金额",-1)),t("span",Ue,"¥"+r(A.value),1)]),e[36]||(e[36]=t("div",{class:"order-info-row"},[t("span",null,"状态"),t("span",{class:"status-badge status-pending"},"待支付")],-1)),t("div",Ae,[e[35]||(e[35]=t("span",null,"剩余时间",-1)),t("span",Pe,r(j.value),1)])]),i.value<=0?(u(),v("div",Te," 订单已过期，请返回重新创建订单 ")):g("",!0),t("div",$e,[k.value?(u(),v("img",{key:0,src:k.value,alt:"支付宝收款码"},null,8,ze)):(u(),v("div",Ve,[...e[37]||(e[37]=[t("p",{style:{color:"var(--text-muted)"}},"请联系管理员获取收款码",-1)])])),e[38]||(e[38]=t("p",{style:{color:"var(--text-muted)"}},"请使用支付宝扫描二维码完成支付",-1)),t("p",qe," 支付时请备注订单号: "+r(b.value),1)]),t("button",{class:"btn btn-success btn-block",onClick:H,disabled:P.value||i.value<=0},r(P.value?"查询中...":i.value<=0?"订单已过期":"我已支付，查询订单状态"),9,De),i.value>0?(u(),v("button",{key:1,class:"btn btn-block",style:{"margin-top":"12px",background:"var(--bg-input)"},onClick:K,disabled:T.value},r(T.value?"取消中...":"取消订单"),9,Ee)):g("",!0),i.value<=0?(u(),v("button",{key:2,class:"btn btn-primary btn-block",style:{"margin-top":"12px"},onClick:N}," 重新创建订单 ")):g("",!0),t("p",Ne,r(i.value>0?"管理员确认收款后，密钥将自动生成":""),1)])):g("",!0),s.value===4?(u(),v("div",_e,[e[40]||(e[40]=t("h2",{class:"card-title",style:{color:"var(--success)"}}," ✓ 支付成功 ",-1)),e[41]||(e[41]=t("p",{style:{"margin-bottom":"20px"}},"您的部署密钥已生成，请妥善保管：",-1)),t("div",Fe,r($.value),1),t("button",{class:"btn btn-primary btn-block",onClick:W}," 复制密钥 "),e[42]||(e[42]=t("div",{class:"alert alert-warning",style:{"margin-top":"20px"}},[t("strong",null,"重要提示："),t("ul",{style:{"margin-top":"8px","padding-left":"20px"}},[t("li",null,"此密钥为一次性使用，部署成功后将失效"),t("li",null,"请下载部署脚本，输入密钥后选择系统进行部署"),t("li",null,"如有问题，请联系客服")])],-1)),t("button",{class:"btn btn-success btn-block",style:{"margin-top":"16px"},onClick:Z}," 下载部署脚本 ")])):g("",!0)])}}};export{Re as default};
